{% extends 'mydidata/base.html' %}
{%block page_description%}
    <meta name="description" content="{{topic.description}}">
{%endblock page_description%}
{%block title%}
    {{topic.topic_title}}
{%endblock title%}
{% block content %}
    <div id="content-container" class="container p-none">
        <hr class="my-3" />
        <div >
            
            {%if test_user_relation and test_user_relation.is_closed%}
                <div class="alert alert-primary" role="alert">
                    A avaliação desta etapa já foi concluída!
                    <a class="alert-link" href="{%url 'mydidata:test_progress' test_user_relation.test.uuid classroom.id %}"> Clique aqui para verificar suas respostas. </a>
                </div>
            {%endif%}
            <div aria-label="Page navigation example" >
                <ul class="pagination" style="justify-content: space-between;">
                  <li class="page-item"><a class="page-link" href="{{topic.previous_url}}">Etapa Anterior</a></li>
                  <li class="page-item"><a class="page-link" href="{{topic.next_url}}">Próxima Etapa</a></li>
                </ul>
      
            </div>    
            
                <div id="gi-container" class="ad-container2">
                    
                    
                    <a href={%if user.is_superuser%}"/mydidata/topic_edit/{{topic.uuid}}/" {%else%}"/mydidata/version/{{topic.id}}/"{%endif%}> Editar </a>
                    | <a href="/mydidata/version_list/{{topic.id}}/"> Versões </a>
                    | <a href="{% url 'mydidata:post_list' topic.id%}"> Fórum de Discussão </a>
                    <h3>Prazos para Envio</h3>
                    {%if user.is_superuser%}
                    <a href="{% url 'mydidata:create_deadline' topic.id %}" class="btn btn-danger">Novo Prazo</a>
                    {%endif%}
                    <hr/>
                    {%for deadline_remaining_time in deadlines%}
                        
                        - <span style="color: red; font-size: 14pt;">{{deadline_remaining_time.0}}</span>
                        <br/>
                        &nbsp;&nbsp;&nbsp; &nbsp; <span style="color: red">Vencimento em: <strong>{{deadline_remaining_time.1}}</strong></span>
                        <br/><br/>
                        &nbsp;&nbsp;&nbsp; &nbsp; <strong style="color:red"> Tempo Restante: {{deadline_remaining_time.2}}</strong>
                        {%if user.is_superuser%}
                            (<a href="{%url 'mydidata:edit_deadline' deadline_remaining_time.3%}">Editar</a> | <a href="{%url 'mydidata:delete_deadline' deadline_remaining_time.3%}">Remover</a>)
                        {%endif%}
                        <hr/>

                    {%endfor%}
                    {% include 'mydidata/topic_item_view.html' %}
                    
                </div>
            

        </div>
        {% if user.is_authenticated and question %}
            <hr class="my-3" />
            <div>
                <h4 class="ad-mh m-none"> Para certificação, selecione e envie o arquivo elaborado neste tutorial </h4>
                <a class="btn btn-lg btn-primary" href="{%url 'mydidata:discursive_answer' question.uuid%}"> Clique para enviar o arquivo desenvolvido neste tópico</a>
            </div>
        {%endif%}
        <hr class="my-3" />
        <div aria-label="Page navigation example" >
            <ul class="pagination" style="justify-content: space-between;">
              <li class="page-item"><a class="page-link" href="{{topic.previous_url}}">Etapa Anterior</a></li>
              <li class="page-item"><a class="page-link" href="{{topic.next_url}}">Próxima Etapa</a></li>
            </ul>
  
        </div>    
        
        {# List Questions #}
        {%if topic.show_questions%}

            <div id="cd-container" >
                <div class="ad-headers">
                    <h4 class="ad-mh m-none">Questões</h4>
                </div>
                <a href="/mydidata/question_types/{{topic.uuid}}">+ Questão</a>
                <div id="cd-body" class="row">
                    <table id="cd-table" class="table">
                        <tbody>
                            <tr></tr>
                            
                            {% for question in questions %}
                                {% include 'mydidata/question_item_view.html' %}
                            {% endfor %}
                            {%if topic.test_enabled%}
                                <tr><a href="{{topic.test_enabled.get_absolute_url}}">Fazer Avaliação</a></tr>
                            {%endif%}
                        </tbody>
                    </table>
                </div>
            </div>
        {%endif%}
        {%if test_user_relation and not test_user_relation.is_closed%}
            <a class="btn btn-lg btn-primary" href="{%url 'mydidata:start_test' test_user_relation.test.uuid%}"> Fazer Avaliação </a>
        {%endif%}
        
        <div id="cd-container" >
            <div class="ad-headers">
                <h4 class="ad-mh m-none">Comentários...</h4>
                <div class="mt-4 flex md:mt-0 md:ml-4">
                    <button type="button" hx-get="{% url 'mydidata:comment_create_form' topic.id %}" hx-target="#commentforms" hx-swap="beforeend" class="btn btn-primary">
                        Comentar
                    </button>
                </div>
                <div id="comments_area"> 
                    {% include 'mydidata/partials/comment_list.html' %}
                </div>
            </div>
        </div>



        {# List Communications #}
    </div>
{% endblock %}
<!-- Modal -->
{% block footer_javascript_page %}
<script type="text/javascript" src="/static/ckeditor/ckeditor-init.js" data-ckeditor-basepath="/static/ckeditor/ckeditor/" id="ckeditor-init-script"></script>

<script type="text/javascript" src="/static/ckeditor/ckeditor/ckeditor.js"></script>
<script>
    function formatDuration(duration) {
        var seconds = Math.floor(duration / 1000);
        var minutes = Math.floor(seconds / 60);
        seconds = seconds % 60;
        return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
    }

    var startTime = new Date().getTime();
    
    window.addEventListener('beforeunload', function() {
    var endTime = new Date().getTime();
    var duration = endTime - startTime;
    // Send an AJAX request to your Django view to record the duration
    debugger;
    $.ajax({
      url: '/mydidata/record_duration/{{topic.id}}/',
      type: 'POST',
      data: {'duration': formatDuration(duration), 'topic_title': '{{topic.topic_title}}'},
      success: function() {
        // Duration recorded successfully
      },
      error: function() {
        // Error recording the duration
      }
    });
  });
</script>

{% endblock %}