<html>
    <head>
        <title>
            Marque a Imagem para Corrigir o Texto
        </title>

        <style>
            #canvas {
                border: 1px solid black;
            }
        </style>


    </head>

    <body>
        
        <canvas id="canvas" width="1200" height="1900"></canvas>
        <br/>
        <input type="text" id="textInput">
        
        <button id="markButton"> Marcar </button>
        <input type="color" name="" id="markColor">
        <input type="range" name="" min="1" max="20" value="1" id="markSize">


        <script>
            var canvas = document.getElementById('canvas');
            canvas.width = 0.8 * window.innerWidth;
            canvas.height = 0.8* window.innerHeight;
            var context = canvas.getContext('2d');

            var image = new Image();
            image.src="{{answer.file_link}}";
            image.onload = function() {
                context.drawImage(image, 0, 0, canvas.width, canvas.height)
            };

            document.getElementById('markButton').addEventListener('click',

                function(){
                    var color = document.getElementById("markColor").value;
                    var size = document.getElementById("markSize").value;
                    context.strokeStyle = color;
                    context.lineWidth = size;
                    context.beginPath();
                    canvas.addEventListener('mousedown', onMouseDown);
                    
            });

            function onMouseDown(event){
                var x = event.offsetX;
                var y = event.offsetY;
                context.strokeStyle = document.getElementById("markColor").value;
                context.rectStart = {x: x, y: y, color: context.strokeColor};

                canvas.addEventListener('mousemove', onMouseMove);
                canvas.addEventListener('mouseup', onMouseUp);
                context.mouseMoved = false
            }

            function onMouseMove(event){
                var x = event.offsetX;
                var y = event.offsetY;
                
                

                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, 0, 0, canvas.width, canvas.height);

                var width = x - context.rectStart.x;
                var height = y - context.rectStart.y;

               
                context.strokeRect(context.rectStart.x, context.rectStart.y, width, height);
                context.mouseMoved = true;
            }

            function onMouseUp(event) {
                var x = event.offsetX;
                var y = event.offsetY;

                canvas.removeEventListener('mousemove', onMouseMove);
                canvas.removeEventListener('mouseup', onMouseUp);
                context.rectangles = context.rectangles || [];
                rectangle = {
                    x: context.rectStart.x,
                    y: context.rectStart.y,
                    width: x - context.rectStart.x,
                    height: y - context.rectStart.y,
                    color: document.getElementById("markColor").value,
                    text: ""

                };
                context.rectangles.push(rectangle);

                startX = rectangle.x;
                startY = rectangle.y;
                selectedRect = rectangle;
                if (context.mouseMoved){
                    text = prompt("Informe o texto da seleção: ");
                    if (text){
                        selectedRect.text = text;
                    }

                }
                context.mouseMoved = false
                redraw();
                
            }

            function redraw(){
                context.clearRect(0,0,canvas.width, canvas.height);
                context.drawImage(image, 0, 0, canvas.width, canvas.height);
                
                context.lineWidth = 1;

                context.rectangles.forEach(function(rect){
                    context.lineWidth = 2;
                    console.log(rect.color);
                    context.strokeStyle = rect.color;
                    context.setLineDash([]);
                    if (rect == selectedRect){
                        context.lineWidth = 3;
                        context.setLineDash([6]);
                        context.strokeStyle = "blue";
                        
    
                    }
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    context.fillStyle = "black";
                    context.font = "12px Arial";
                    context.fillText(rect.text, rect.x + 10, rect.y + 20);
                });


            }

            document.getElementById("addTextBtn").addEventListener("click", function() {
              var text = document.getElementById("textInput").value;
              context.fillStyle = "black";
              context.font = "20px Arial";
              if(selectedRect){
                context.fillText(text, startX + 10, startY + 25);
                selectedRect.text = text;
                redraw()
              } else {alert("Selecione uma marcação para adicionar o texto")}

            });
            
            canvas.addEventListener("click", function(e) {
                let rectangles = context.rectangles
                var x = e.clientX - canvas.offsetLeft;
                var y = e.clientY - canvas.offsetTop;
                for (var i = rectangles.length - 1; i >= 0; i--) {
                  if (x >= rectangles[i].x && x <= rectangles[i].x + rectangles[i].width && y >= rectangles[i].y && y <= rectangles[i].y + rectangles[i].height) {
                    selectedRect = rectangles[i];
                    
                    redraw();
                    break;
                  }
                }
              
            });

            canvas.addEventListener("dblclick", function(e) {
                let rectangles = context.rectangles
                var x = e.clientX - canvas.offsetLeft;
                var y = e.clientY - canvas.offsetTop;
                for (var i = rectangles.length - 1; i >= 0; i--) {
                  if (x >= rectangles[i].x && x <= rectangles[i].x + rectangles[i].width && y >= rectangles[i].y && y <= rectangles[i].y + rectangles[i].height) {
                    selectedRect = rectangles[i];
                    text = prompt("Edição de texto", selectedRect.text)
                    selectedRect.text = text;

                    redraw();
                    break;
                  }
                }
            
            });



        </script>
    </body>
    
    
    

</html>